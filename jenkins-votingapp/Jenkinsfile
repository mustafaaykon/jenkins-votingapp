pipeline {
    agent {    
        kubernetes {
          yaml '''
            apiVersion: v1
            kind: Pod
            spec:
              containers:
              - name: maven
                image: maven:alpine
                command:
                - cat
                tty: true
              - name: docker
                image: docker:latest
                command:
                - cat
                tty: true
                volumeMounts:
                 - mountPath: /var/run/docker.sock
                   name: docker-sock
              volumes:
              - name: docker-sock
                hostPath:
                  path: /var/run/docker.sock 
            '''
        }
    }
    environment {
        ECR_REPO_REGISTRY = '762247940679.dkr.ecr.us-east-1.amazonaws.com/jenkins_votingapp'
    }
    stages {

        // stage ('Login to ECR') {
        //     steps {
        //         withAWS(region: 'us-east-1'){
        //             script{
        //                 def login = ecrLogin()
        //                 def images = ecrListImages(repositoryName: 'jenkins_votingapp')
        //                 }
        //             }
        //         }
        //     }


        stage ('Build') {
            steps {
                script {
                    container('docker') {
                        sh 'docker login --username AWS --password-stdin 762247940679.dkr.ecr.us-east-1.amazonaws.com'
                        sh 'docker build -t ${ECR_REPO_REGISTRY}/vote:latest ./jenkins-votingapp/vote'
                        sh 'docker build -t ${ECR_REPO_REGISTRY}/result:latest ./jenkins-votingapp/result'
                        sh 'docker build -t ${ECR_REPO_REGISTRY}/worker:latest ./jenkins-votingapp/worker'
                        sh 'docker tag ${ECR_REPO_REGISTRY}/vote:latest ${ECR_REPO_REGISTRY}/vote:""$BUILD_ID""'
                        sh 'docker tag ${ECR_REPO_REGISTRY}/result:latest ${ECR_REPO_REGISTRY}/result:""$BUILD_ID""'
                        sh 'docker tag ${ECR_REPO_REGISTRY}/worker:latest ${ECR_REPO_REGISTRY}/worker:""$BUILD_ID""'
                        sh 'docker push ${ECR_REPO_REGISTRY}/vote:latest' 
                        sh 'docker push ${ECR_REPO_REGISTRY}/vote:$""$BUILD_ID""'
                        sh 'docker push ${ECR_REPO_REGISTRY}/worker:latest' 
                        sh 'docker push ${ECR_REPO_REGISTRY}/worker:$""$BUILD_ID""'
                        sh 'docker push ${ECR_REPO_REGISTRY}/result:latest' 
                        sh 'docker push ${ECR_REPO_REGISTRY}/result:$""$BUILD_ID""'
                    }                       
                }    
            }
        }
        // stage ('Push') {
        //     steps {
        //         script {
        //                 docker.withRegistry('https://762247940679.dkr.ecr.us-east-1.amazonaws.com', 'ecr:us-east-1:aws-instance-role') {
        //             docker.push('${ECR_REPO_REGISTRY}/vote:latest')
        //             docker.push('${ECR_REPO_REGISTRY}/vote:$""$BUILD_ID""')
        //                 }
        //         }
        //     }
        // }
    }
}