pipeline {
    agent {    
        kubernetes {
          yaml '''
            apiVersion: v1
            kind: Pod
            spec:
              containers:
              - name: maven
                image: maven:alpine
                command:
                - cat
                tty: true
              - name: docker
                image: docker:latest
                command:
                - cat
                tty: true
                volumeMounts:
                 - mountPath: /var/run/docker.sock
                   name: docker-sock
              volumes:
              - name: docker-sock
                hostPath:
                  path: /var/run/docker.sock    
            '''
        }
    }
    stages {

        stage ('Login to ECR') {
            steps {
                withAWS(region: 'us-east-1'){
                    script{
                        def login = ecrLogin()
                        def images = ecrListImages(repositoryName: 'jenkins_votingapp')
                        }
                    }
                }
            }

        stage ('Build') {
            steps {
                container('docker') {
                    sh 'docker build -t votingapp/vote:latest ./jenkins-votingapp/vote'
                    sh 'docker build -t votingapp/result:latest ./jenkins-votingapp/result'
                    sh 'docker build -t votingapp/worker:latest ./jenkins-votingapp/worker'
                }
            }
        }
    }
}