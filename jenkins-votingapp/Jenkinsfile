pipeline {
    agent {    
        kubernetes {
          yaml '''
            apiVersion: v1
            kind: Pod
            spec:
              containers:
              - name: docker
                image: docker:latest
                command:
                - cat
                tty: true
                volumeMounts:
                 - mountPath: /var/run/docker.sock
                   name: docker-sock             
              volumes:
              - name: docker-sock
                hostPath:
                  path: /var/run/docker.sock

            '''
        }
    }
    environment {
        ECR_REPO_REGISTRY = '762247940679.dkr.ecr.us-east-1.amazonaws.com/jenkins_votingapp'
    }
    stages {
        // stage ('Login to ECR') {
        //     steps {
        //             script{
        //                 sh 'apk add --no-cache \
        //                     python3 \
        //                     py3-pip \
        //                     && pip3 install --upgrade pip \
        //                     && pip3 install --no-cache-dir \
        //                     awscli \
        //                     && rm -rf /var/cache/apk/*'
        //                 sh 'aws --version'       
        //                 }
        //         }
        //     }

        stage ('Build') {
            steps {
                    script {
                        container('docker') {
                            sh 'apk add --no-cache \
                                python3 \
                                py3-pip \
                                && pip3 install --upgrade pip \
                                && pip3 install --no-cache-dir \
                                awscli \
                                && rm -rf /var/cache/apk/*'
                            sh 'aws --version'                               

                            sh "aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 762247940679.dkr.ecr.us-east-1.amazonaws.com"
                            sh 'docker build -t jenkins_votingapp_vote ./jenkins-votingapp/vote'
                            sh 'docker tag 762247940679.dkr.ecr.us-east-1.amazonaws.com/jenkins_votingapp_vote:latest 762247940679.dkr.ecr.us-east-1.amazonaws.com/jenkins_votingapp_vote:${env.BUILD_ID}'
                            sh 'docker push 762247940679.dkr.ecr.us-east-1.amazonaws.com/jenkins_votingapp_vote:latest'
                            sh 'docker push 762247940679.dkr.ecr.us-east-1.amazonaws.com/jenkins_votingapp_vote:${env.BUILD_ID}'
                        }                       
                }       
            }
        }
    //     stage ('Push') {
    //         steps {
    //             script {
    //                 withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws-instance-role']]) {
    //                         docker.withRegistry('https://762247940679.dkr.ecr.us-east-1.amazonaws.com', 'ecr') {
    //                     docker.image('${ECR_REPO_REGISTRY}/vote:latest').push()
    //                     docker.image('${ECR_REPO_REGISTRY}/vote:$""$BUILD_ID""').push()
    //                         }
    //             }
    //         }
    //     }
    // }
    } 
}